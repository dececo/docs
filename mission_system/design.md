# 付费任务系统设计文档

## 一．引言

### 1. 编写目的

本文档面向付费任务系统的产品、开发、测试，及其他相关人员。

### 2. 项目背景

付费任务系统是 [DEC](dechain.io) 旗下生态系统中重要的垂直行业细分领域产品，专门针对软件开发相关人员，包括但不限于开发、产品、运营及外包等。

### 3. 名词解释

* **付费**: 该文档中所说的付费，通常指的是支付 [DET](https://github.com/dececo/docs/blob/master/token/det/DET.md)。
* **ABI**: Application Binary Interface，应用二进制接口，以太坊智能合约编译时会随二进制一起提供。
* **MissionID**: 全局唯一的任务ID，由[任务管理平台](#任务管理平台)在任务上传时生成。
* **SolutionID**: 全局唯一的解决方案ID，由[任务管理平台](#任务管理平台)在任务完成时生成。

### 4. 参考资料

* **以太坊(ethereum)**: https://ethereum.org/
* **Oraclize**: https://docs.oraclize.it/

## 二．总体设计

付费任务系统是一个基于区块链的分布式系统，由[智能合约](#智能合约)，[任务管理平台](#任务管理平台)、[任务展示平台](#任务展示平台)、[任务鉴定平台](#任务鉴定平台)、[任务鉴定平台](#任务鉴定平台)构成。

- **[智能合约](#任务鉴定平台)**：系统交易部分，会全部上链，做到公开透明。因此交易逻辑会由多组智能合约协同完成。
- **[任务管理平台](#任务管理平台)**：托管用户上传的任务说明和后续的交付物。是智能合约最主要的驱动方。
- **[任务展示平台](#任务管理平台)**：展示现有任务列表，以及一些较为简单的互动，如点赞、关注等，包括但不限于客户端、网页等。
- **[任务鉴定平台](#任务管理平台)**：对任务完成与否进行鉴定。一般不需要，只有交易双方出现分歧时才引入。
- **[任务撮合系统](#任务管理平台)**：对任务进行撮合并推送到相关用户。因前期采用广播模式，该模块不需要实现。

### 1. 需求概述

### 2. 软件结构
*（如给出软件系统的结果图。）*

## 三．程序描述（逐个模块给出以下的说明）

### 智能合约

智能合约完成的是核心交易逻辑，包括提交任务时抵押 [DET](https://github.com/dececo/docs/blob/master/token/det/DET.md)，完成任务时支付 [DET](https://github.com/dececo/docs/blob/master/token/det/DET.md) 等。

#### 1．功能

1. 向指定地址转账指定数额的 [DET](https://github.com/dececo/docs/blob/master/token/det/DET.md)，可用于指定任务的抵押或者支付；
2. 获取指定任务的鉴定结果（是否胜诉及可获得财产比例）；
3. 从系统账户取回 [DET](https://github.com/dececo/docs/blob/master/token/det/DET.md)，可用于鉴定胜诉时取回资产；

#### 2．性能

目前基于以太坊，执行速度取决于`Gas Price`设置，不建议使用超高`Gas`加速，推荐将所有交易和回调**异步**化。

#### 3．输入项目

预先定义的合约函数，一般由[任务管理平台](#任务管理平台)发起调用。当然也可以由其他任何第三方发起调用。

#### 4．输出项目

除合约状态改变外，还会输出 Event Log 。部分场合可能还会通过 Oraclize 调用其他平台，如[任务管理平台](#任务管理平台)和[任务鉴定平台](#任务管理平台)等。

#### 5．算法

无特殊算法。

#### 6．程序逻辑

待补充。

#### 7．接口

待补充，最后会以 ABI 形式确认。

#### 8．存储分配

无

#### 9．限制条件

任何人都可能对合约发起调用，但只有符合条件的才能执行成功。例如，只有完成了任务的人才能取走属于自己的那部分佣金。

#### 10． 测试要点

1. 完成任务后才能取走相应比例的佣金；
2. 任务发起后资金抵押，任务取消前或完成前，资金不能移动；
更多要点详见功能。

### 任务管理平台

任务管理平台托管用户上传的任务说明和后续的交付物。是智能合约最主要的驱动方。

#### 1．功能

1. 简单的登录功能，无需实名验证，并可以把 ID 与公钥/地址关联；
2. 上传任务说明（引入版本控制前，暂定上传后不能更改），生成全局唯一的任务`MissionID`；
3. 上传解决方案说明（交付物，引入版本控制前，暂定上传后不能更改），生成全局唯一的`SolutionID`；
4. 对任务说明和完成说明留言评论，及点赞互动；
5. 确认接受任务交付/任务完成；
6. 请求鉴定机构鉴定任务是否完成及完成百分比；
7. 按完成百分比支付佣金（调用智能合约）；
8. 提供鉴定结果（供智能合约调用）；
9. 权限控制（仅能查看自己发布的任务的解决方案，或自己提交的解决方案）；

#### 2．性能

服务将部署在 AWS 上（最好是使用 Docker），并使用 RDS 作为存储。
1. QPS 无苛刻要求；
2. 内存要求 8G 以下；

#### 3．输入项目

用户上传或点击。

#### 4．输出项目

- 动作完成的相关提示
- 智能合约调用
- 写数据库等持久化存储（RDS）

#### 5．算法

无特殊算法。

#### 6．程序逻辑

待补充细化。

#### 7．接口

1. 登录；
2. 上传/下载任务说明/完成说明/附件；
3. 点赞互动；
4. 任务确认；
5. 发起诉讼/鉴定；
6. 接受鉴定结果；
7. （胜诉方）取回资产（调用智能合约）；

#### 8．存储分配

[AWS RDS](https://amazonaws-china.com/cn/rds/)。

#### 9．限制条件

依赖项要尽量精简，推荐使用 Docker 方式部署，能打包成 Docker 镜像最好。

#### 10． 测试要点

见功能。

### 任务展示平台

任务展示平台展示现有任务列表，以及一些较为简单的互动，如点赞、关注等，包括但不限于客户端、网页等。

以下功能仅以网页端为例。

#### 1．功能

1. 展示任务列表，包含完成情况和点赞互动统计；
2. 任务详情页面，可以查看完成情况和解决方案细节（仅有权限的任务解决方案）；
3. 点赞互动；
4. 上传任务或解决方案；
5. 发起鉴定；
6. 确认解决方案或鉴定；
7. 取回资产；

#### 2．性能

服务将部署在 AWS 上（最好是使用 Docker）。
1. QPS 无苛刻要求；
2. 内存要求 4G 以下；

#### 3．输入项目

无

#### 4．输出项目

详见功能。

#### 5．算法

无特殊算法。

#### 6．程序逻辑

待补充。

#### 7．接口

无外部调用方。

#### 8．存储分配

无。

#### 9．限制条件

依赖项要尽量精简，推荐使用 Docker 方式部署，能打包成 Docker 镜像最好。

#### 10． 测试要点

详见功能。

### 任务鉴定平台

任务鉴定平台对任务完成与否进行鉴定。一般不需要，只有交易双方出现分歧时才引入。

#### 1．功能

1. 投票决定是否接受任务完成，以及任务完成百分比；
2. 提供任务完成百分比，供智能合约查询；

#### 2．性能

服务将部署在 AWS 上（最好是使用 Docker），并使用 RDS 作为存储。
1. QPS 无苛刻要求；
2. 内存要求 8G 以下；

#### 3．输入项目



#### 4．输出项目



#### 5．算法

待补充投票规则。

#### 6．程序逻辑



#### 7．接口

##### **鉴定结果查询接口**
标准 JSONAPI 接口，支持 HTTPS 协议。

请求参数如下：
  - `solution_id`: 要查询解决方案ID
  - `publisher`: 任务发布者的公钥地址
  - `proposer`: 任务解决人/解决方案提议人

返回参数如下：
- `solution_id`: 要查询解决方案ID
- `publisher`: 任务发布者的公钥地址
- `proposer`: 任务解决人/解决方案提议人公钥地址
- `completed`: 是否完成，完成: `true`, 未完成: `false`
- `percentage`: 完成百分比，`0-100`的整数，比如`30`表示该任务完成了`30%``

注意：
**在合约调用中该URL地址加密**。

#### 8．存储分配

[AWS RDS](https://amazonaws-china.com/cn/rds/)。

#### 9．限制条件

无。

#### 10． 测试要点

见功能。

### 任务撮合系统

#### 1．功能



#### 2．性能

服务将部署在 AWS 上（最好是使用 Docker），并使用 RDS 作为存储。
1. QPS 无苛刻要求；
2. 内存要求 8G 以下；

#### 3．输入项目



#### 4．输出项目



#### 5．算法

自定义撮合算法是撮合系统的核心，每个实现均可以不同。

#### 6．程序逻辑



#### 7．接口



#### 8．存储分配



#### 9．限制条件

无。

#### 10． 测试要点

见功能。
